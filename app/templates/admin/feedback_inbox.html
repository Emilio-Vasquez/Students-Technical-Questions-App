{% extends "base.html" %}

{% block title %}Feedback Inbox - Admin Dashboard{% endblock %}

{% block content %}
<div class="admin-container" style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
    <h2 style="text-align: center; margin-bottom: 2rem;">User Feedback Inbox</h2>

    <form method="get" action="{{ url_for('admin.feedback_inbox') }}" style="margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 1rem; justify-content: space-between; align-items: flex-end;">
        <input type="text" name="username" value="{{ request.args.get('username', '') }}" placeholder="Username" style="padding: 0.5rem; flex: 1;">

        <select name="category" style="padding: 0.5rem; flex: 1;">
            <option value="">All Categories</option>
            <option value="general" {% if request.args.get('category') == 'general' %}selected{% endif %}>General</option>
            <option value="bug" {% if request.args.get('category') == 'bug' %}selected{% endif %}>Bug Report</option>
            <option value="suggestion" {% if request.args.get('category') == 'suggestion' %}selected{% endif %}>Suggestion</option>
        </select>

        <div style="flex: 1; display: flex; flex-direction: column;">
            <label for="start_date" style="font-size: 0.8rem; margin-bottom: 0.25rem;">Start Date</label>
            <input type="date" name="start_date" id="start_date"
                  value="{{ request.args.get('start_date', '') }}"
                  max="{{ request.args.get('end_date', '') or today }}"
                  style="padding: 0.5rem;">
        </div>

        <div style="flex: 1; display: flex; flex-direction: column;">
            <label for="end_date" style="font-size: 0.8rem; margin-bottom: 0.25rem;">End Date</label>
            <input type="date" name="end_date" id="end_date"
                  value="{{ request.args.get('end_date', '') }}"
                  min="{{ request.args.get('start_date', '') }}"
                  max="{{ today }}"
                  style="padding: 0.5rem;">
        </div>

        <button type="submit" style="padding: 0.5rem 1rem;">Filter</button>
    </form>

    <div class="table-wrapper">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
            <thead>
                <tr style="background-color: #f4f4f4; border-bottom: 2px solid #ddd;">
                    <th style="padding: 0.75rem;">ID</th>
                    <th style="padding: 0.75rem;">User</th>
                    <th style="padding: 0.75rem;">Message</th>
                    <th style="padding: 0.75rem;">Date-of-Submission</th>
                </tr>
            </thead>
            <tbody>
                {% for fb in feedback_list %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.75rem;">{{ fb.id }}</td>
                    <td style="padding: 0.75rem;">{{ fb.user_display_name }}</td>
                    <td style="padding: 0.75rem;">
                      <div class="truncated-message" style="max-height: 5.5em; overflow: hidden; position: relative;">
                        {{ fb.message }}
                        <div class="fadeout" style="
                          position: absolute;
                          bottom: 0;
                          left: 0;
                          width: 100%;
                          height: 1.2em;
                          background: linear-gradient(transparent, #fdf0d2);
                          pointer-events: none;"></div>
                      </div>
                      <a href="#" onclick="toggleExpand(this); return false;" style="font-size: 0.85rem; display: inline-block; margin-top: 0.25rem;">Show more</a>
                    </td>
                    <td style="padding: 0.75rem;">{{ fb.submitted_at.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" style="padding: 1rem; text-align: center; color: #888;">No feedback entries yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top: 2rem; text-align: center;">
          {% if total_pages > 1 %}
              <div class="pagination">
                  {% set args_without_page = request.args.to_dict() | dictsort %}
                  {% set args_without_page = args_without_page | selectattr(0, 'ne', 'page') | list %}

                  {% if current_page > 1 %}
                      <a href="{{ url_for('admin.feedback_inbox', page=current_page-1, **dict(args_without_page)) }}">&laquo; Prev</a>
                  {% endif %}

                  {% for p in range(1, total_pages + 1) %}
                      {% if p == current_page %}
                          <strong>{{ p }}</strong>
                      {% else %}
                          <a href="{{ url_for('admin.feedback_inbox', page=p, **dict(args_without_page)) }}">{{ p }}</a>
                      {% endif %}
                  {% endfor %}

                  {% if current_page < total_pages %}
                      <a href="{{ url_for('admin.feedback_inbox', page=current_page+1, **dict(args_without_page)) }}">Next &raquo;</a>
                  {% endif %}
              </div>
          {% endif %}
      </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/inbox_message_display.js') }}"></script>
{% endblock %}
