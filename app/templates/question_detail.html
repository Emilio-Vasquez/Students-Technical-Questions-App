{% extends "base.html" %}

{% block title %}{{ question.title }} - Technical Questions App{% endblock %}

{% block content %}
<div class="question-detail-container" style="max-width: 900px; margin: 0 auto;">
    <h2 style="text-align: center;">{{ question.title }}</h2>
    <div class="question-prompt">
        {{ question.prompt.replace('\n', '  \n') | markdown | safe }}
    </div>

    {% if table_metadata %}
    <hr>
    <div class="table-section">
        <h4 style="text-align: center; margin-bottom: 2rem;">Tables & Sample Data</h4>

        {% for table in table_metadata %}
        <div class="table-block" style="margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 6px; background-color: #fafafa;">
            <h5 style="text-align: center; margin-bottom: 1rem;">{{ table.table_name }}</h5>

            <p><strong>Columns:</strong></p>
            <table style="margin: 0 auto 1rem auto; border-collapse: collapse; width: auto;">
                <thead>
                    <tr style="background-color: #f2f2f2;">
                        <th style="padding: 6px 12px; text-align: left;">Name</th>
                        <th style="padding: 6px 12px; text-align: left;">Type</th>
                    </tr>
                </thead>
                <tbody>
                    {% for col in table.columns %}
                    <tr>
                        <td style="padding: 6px 12px;">{{ col.name }}</td>
                        <td style="padding: 6px 12px;">{{ col.type }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <p><strong>Sample Data (Top 5 rows):</strong></p>
            <div style="display: flex; justify-content: center; overflow-x: auto;">
                <table border="1" style="border-collapse: collapse; width: auto; max-width: 100%;">
                    <thead style="background-color: #f9f9f9;">
                        <tr>
                            {% for col in table.columns %}
                                <th style="padding: 6px 10px;">{{ col.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in table.rows %}
                        <tr>
                            {% for cell in row %}
                                <td style="padding: 6px 10px;">{{ cell }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" action="{{ url_for('main.question_detail', slug=question.slug) }}" style="margin-top: 2rem;">
        <div class="form-group" style="margin-bottom: 1rem;">
            <label for="language"><strong>Language:</strong></label>
            <select name="language" id="language">
                <option value="python" {% if question.language == "python" %}selected{% endif %}>Python</option>
                <option value="sql" {% if previous_language == "sql" %}selected{% endif %}>SQL</option>
            </select>
        </div>

        <div class="form-group">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label for="answer"><strong>Your Solution:</strong></label>
                <button type="button" id="theme-toggle" style="
                    font-size: 0.8rem;
                    padding: 0.2rem 0.5rem;
                    background-color: #670b14;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    margin-bottom: 0.5rem;
                ">Switch Theme</button>
            </div>
            <textarea name="answer" id="answer" style="width: 100%; height: 200px;">{{ submitted_answer if submitted_answer else question.function_signature }}</textarea>
        </div>

        <button type="submit" style="margin-top: 1rem;">Submit</button>
    </form>

    {% if evaluation_results %}
        <h3>Evaluation Results</h3>
        {% for test in evaluation_results %}
            <div class="test-case-box {% if test.passed %}pass{% else %}fail{% endif %}">
                <details>
                    <summary>
                        <strong>Test {{ loop.index }}:</strong> {{ test.description }},
                        {% if test.passed %}✅ Pass{% else %}❌ Fail{% endif %}
                        <span style="float: right;">{{ test.time }}</span>
                    </summary>
                    <p><strong>Input:</strong></p>
                    <pre><code>{{ test.input | tojson }}</code></pre>

                    <p><strong>Expected Output:</strong></p>
                    <pre><code>{{ test.expected }}</code></pre>

                    <p><strong>Your Output:</strong></p>
                    <pre><code>{{ test.result }}</code></pre>

                    {% if test.error %}
                    <p><strong>Error:</strong></p>
                    <pre><code>{{ test.error }}</code></pre>
                    {% endif %}
                </details>
            </div>
        {% endfor %}
    {% endif %}

    <p style="margin-top: 2rem;">
        <a href="{{ url_for('main.questions') }}" class="back-button">← Back to Questions</a>
    </p>
    
    <hr>
    <div class="comments-section" style="margin-top: 2rem;">
        <h3>Discussion</h3>

        {% for comment in comments %}
            {% if not comment.parent_id %}
                <div class="comment" style="margin-bottom: 1.5rem;">
                    <!-- Top-Level Comment -->
                    <p>
                        <strong>{{ comment.username or "Anonymous" }}</strong>
                        <span style="color: gray; font-size: 0.9em;">
                            — {{ comment.created_at.strftime("%B %d, %Y at %I:%M %p") }}
                        </span>
                    </p>
                    <p>{{ comment.content }}</p>

                    {% set reply_count = comment.replies | length %}
                    <!-- Toggle Replies Button -->
                    <button class="toggle-replies-btn" data-comment-id="{{ comment.id }}">
                        {% if reply_count > 0 %}
                            View Replies ({{ reply_count }})
                        {% else %}
                            Reply
                        {% endif %}
                    </button>

                    <!-- Replies Container -->
                    <div class="replies" id="replies-{{ comment.id }}" style="margin-left: 2rem; display: none;">
                        {% for reply in comment.replies %}
                            <div class="reply" style="margin-bottom: 1rem;">
                                <p>
                                    <strong>{{ reply.username or "Anonymous" }}</strong>
                                    <span style="color: gray; font-size: 0.85em;">
                                        — {{ reply.created_at.strftime("%B %d, %Y at %I:%M %p") }}
                                    </span>
                                </p>
                                <p>{{ reply.content }}</p>
                            </div>
                        {% endfor %}

                        <!-- Reply Form -->
                        {% if 'username' in session %}
                            <form method="post" action="{{ url_for('comment.post_comment', question_id=question.id) }}" class="reply-form" style="margin-top: 0.5rem;">
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <input type="hidden" name="slug" value="{{ question.slug }}">
                                <textarea name="content" rows="2" placeholder="Write a reply..." required></textarea>
                                <button type="submit">Reply</button>
                            </form>
                        {% else %}
                            <form onsubmit="handleNotLoggedIn(event)" class="reply-form" style="margin-top: 0.5rem;">
                                <textarea rows="2" placeholder="Log in to reply." disabled></textarea>
                                <button type="submit">Reply</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                <hr>
            {% endif %}
        {% endfor %}

        <!-- New Top-Level Comment Form -->
        <h4 style="margin-top: 2rem;">Add a Comment</h4>
        {% if 'username' in session %}
            <form method="post" action="{{ url_for('comment.post_comment', question_id=question.id) }}">
                <input type="hidden" name="slug" value="{{ question.slug }}">
                <textarea name="content" rows="4" placeholder="Write your comment here..." required></textarea>
                <button type="submit">Post Comment</button>
            </form>
        {% else %}
            <form onsubmit="handleNotLoggedIn(event)">
                <textarea rows="4" placeholder="You must be logged in to post a comment." disabled></textarea>
                <button type="submit">Post Comment</button>
            </form>
        {% endif %}
    </div>
</div>

<script src="{{ url_for('static', filename='js/code_editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/question_comments.js') }}"></script>
{% endblock %}
